SELECT staging.load_retailer_data(data, flag)
FROM staging.load
WHERE id = 1;


/*
[2024-12-05 11:22:12] 1 row retrieved starting from 1 in 6 m 3 s 929 ms (execution: 6 m 3 s 896 ms, fetching: 33 ms)
-199
+-------+--------+---------+----------------------------------------------------------------------------------------+---------------------------------------------+----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+--------------------------+----+----------+-------+-----------+----------+--------------+
|load_id|error_id|sql_state|message                                                                                 |detail                                       |hint|context                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |flag              |created_at                |flag|created_at|dd_date|dd_retailer|dd_date_id|dd_source_type|
+-------+--------+---------+----------------------------------------------------------------------------------------+---------------------------------------------+----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+--------------------------+----+----------+-------+-----------+----------+--------------+
|199    |1       |23505    |duplicate key value violates unique constraint "product_status_history_productid_uindex"|Key ("productId")=(312672016) already exists.|    |SQL statement "INSERT INTO staging.product_status_history("retailerId", "coreProductId", date, "productId", status)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |create-products-pp|2024-12-05 10:16:08.772815|null|null      |null   |null       |null      |null          |
|       |        |         |                                                                                        |                                             |    |--SELECT "retailerId", "coreProductId", date, id AS "productId", status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |SELECT "retailerId", "coreProductId", date, MAX(id) AS "productId", status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |FROM tmp_product_pp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |GROUP BY "retailerId", "coreProductId", date, status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |ON CONFLICT ("retailerId", "coreProductId", date)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |DO UPDATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |SET status=excluded.status"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |PL/pgSQL function staging.load_retailer_data_pp(json,integer) line 837 at SQL statement                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |SQL statement "SELECT staging.load_retailer_data_pp(fetched_data, _load_id)"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                  |                          |    |          |       |           |          |              |
|       |        |         |                                                                                        |                                             |    |PL/pgSQL function staging.load_retailer_data(json,text) line 26 at PERFORM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                  |                          |    |          |       |           |          |              |
+-------+--------+---------+----------------------------------------------------------------------------------------+---------------------------------------------+----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+--------------------------+----+----------+-------+-----------+----------+--------------+

*/


SELECT staging.load_retailer_data(data, flag)
FROM staging.load
WHERE id > 1
  AND id <= 166;



CREATE TABLE staging.fix_product_status_history_coreproducts AS
SELECT id AS "productId", date, "dateId", load_id, "coreProductId" AS latest_coreProductId
FROM products
WHERE "retailerId" = 1
  AND "dateId" >= 29980;
--[2024-12-05 12:34:33] 877,701 rows affected in 24 s 504 ms

SELECT *
FROM staging.product_status_history
         INNER JOIN staging.fix_product_status_history_coreproducts USING ("productId")
WHERE "coreProductId" != latest_coreproductid;


SELECT "createdAt", "updatedAt"
FROM products
WHERE id IN (
             312672016,
             313862840,
             314009389,
             314790400,
             315543692
    );

CREATE TABLE staging.fix_product_status_history_bck AS
SELECT *
FROM staging.product_status_history
WHERE "coreProductId" IN (1006430, 584735);


SELECT DISTINCT "coreProductId"
FROM PRODUCTS
WHERE ID IN
      (183110466, 183421477, 183758657, 184013207, 184466643, 184690195, 185001445, 185421418, 185621449, 185971960,
       186280057, 186700708, 186879670, 187200314, 187503403, 187865825, 188192207, 188512758, 188892489, 189131699,
       189450799, 189777857, 190089946, 190416993, 190708011, 191016148, 191370222, 191689324, 191964673, 192266991,
       192625344, 192973052, 193284908, 193603427, 193902868, 194227522, 194558913, 194857552, 195186476, 195508999,
       195828226, 196146316, 196465572, 196848228, 197169025, 197424233, 197708937, 198054174, 198445330, 198759121,
       199085789, 199329153, 199714516, 199963779, 200324754, 200842354, 201519253, 202386070, 203023655, 203776053,
       204802783, 205278306, 206060964, 207088285, 207793558, 208264161, 209383385, 209894131, 210868943, 211657531,
       212303082, 213146165, 213791947, 214611692, 215116491, 215538420, 216218557, 216944639, 217710260, 218407059,
       219142088, 219807305, 220137750, 220468666, 220794025, 221082377, 221471648, 221791086, 222121463, 222458099,
       222794028, 223102409, 223429313, 223755759, 224066932, 224364368, 224720864, 225044501, 225366479, 225678848,
       226006580, 226337040, 226665595, 227234681, 227829462, 228171070, 228491222, 228812163, 229122238, 229446804,
       229775280, 230102780, 230414864, 230898835, 231285509, 231583541, 231806421, 232237649, 232582463, 232932885,
       233225212, 233580898, 233890035, 234239930, 234579937, 234911600, 235229777, 235563675, 235890864, 236533584,
       237236198, 237916972, 238570839, 239359852, 239690308, 240086352, 240402944, 240694340, 241194355, 241565753,
       241908482, 242296319, 242652891, 243002905, 243401014, 243774696, 244107976, 244432426, 245142144, 245522544,
       245914388, 246229185, 246674733, 247050803, 247433065, 247834655, 248207589, 248550580, 248981372, 249348161,
       249637873, 250101078, 250478794, 250887911, 251239359, 251796679, 252507974, 253167212, 253917354, 254727257,
       255185702, 255601837, 256038135, 256477543, 256911862, 257341584, 257607241, 258207909, 258629441, 259086200,
       259473390, 259874431, 260432186, 261240298, 261769620, 262148826, 262946158, 263488510, 264208035, 264714336,
       265345607, 265882137, 266334250, 266858962, 267354703, 268075061, 268875474, 269507231, 269923826, 270449383,
       270978982, 271400111, 271911385, 272453383, 272917819, 273407012, 273896220, 274390215, 274846926, 275254485,
       275714814, 276186404, 276940218, 277311405, 277815362, 278336701, 278964972, 279673890, 280259197, 280809976,
       281503251, 281991820, 282460208, 283285212, 283893811, 284521099, 285075630, 286579920, 287107545, 287557239,
       288115554, 288658610, 288949662, 289476596, 289955368, 290616143, 291238485, 291828876, 292520127, 293158241,
       293844902, 294254707, 295152756, 295784781, 296446053, 297105836, 297745621, 298432762, 299105140, 299791538,
       300453924, 301052862, 301723925, 302361937, 303070704, 303739143, 304488138, 305039709, 305736196, 306432936,
       307099672, 307789197, 308412507, 309043955, 309749911, 310427193, 311098712, 311762287, 312672016, 313862840,
       314009389, 314790400, 315543692);


UPDATE staging.product_status_history
SET "coreProductId"=584735
WHERE "coreProductId" = 1006430;
--[2024-12-05 12:56:28] 273 rows affected in 1 m 27 s 786 ms
UPDATE staging.product_status_history
SET status='Re-listed'
WHERE "productId" = 183110466;
--[2024-12-05 12:56:28] 1 row affected in 65 ms
UPDATE staging.product_status_history
SET status='Listed'
WHERE "productId" = 316216897;
--[2024-12-05 12:56:28] 1 row affected in 65 ms
